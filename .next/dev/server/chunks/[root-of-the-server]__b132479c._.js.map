{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yeral/Downloads/PRUEBAIA/lib/db.ts"],"sourcesContent":["import mysql from \"mysql2/promise\"\n\n// 1. Declarar variable global para evitar múltiples conexiones en modo desarrollo\ndeclare global {\n  var mysqlPool: mysql.Pool | undefined\n}\n\nlet pool: mysql.Pool\n\n// 2. Configuración de la conexión\n// Usamos las variables de entorno que configuramos en .env.local\nconst dbConfig = {\n  uri: process.env.DATABASE_URL, // Prioridad a la URL completa\n  host: process.env.MYSQL_HOST,\n  user: process.env.MYSQL_USER,\n  password: process.env.MYSQL_PASSWORD,\n  database: process.env.MYSQL_DATABASE,\n  port: Number(process.env.MYSQL_PORT) || 3306,\n  waitForConnections: true,\n  connectionLimit: 10,\n  queueLimit: 0,\n  enableKeepAlive: true, // Vital para Railway\n  keepAliveInitialDelay: 0,\n}\n\n// 3. Lógica Singleton: Si ya existe un pool, úsalo. Si no, créalo.\nif (!global.mysqlPool) {\n  // Si hay una URL completa (DATABASE_URL), úsala\n  if (process.env.DATABASE_URL) {\n      global.mysqlPool = mysql.createPool({\n          uri: process.env.DATABASE_URL,\n          waitForConnections: true,\n          connectionLimit: 10,\n          enableKeepAlive: true\n      })\n  } else {\n      // Si no, usa los parámetros individuales\n      global.mysqlPool = mysql.createPool(dbConfig)\n  }\n}\n\npool = global.mysqlPool\n\n// 4. Función helper para ejecutar queries\nexport async function query<T = any>(sql: string, params?: any[]): Promise<{ rows: T[]; fields?: any }> {\n  try {\n    const [rows, fields] = await pool.execute(sql, params || [])\n    return { rows: rows as T[], fields }\n  } catch (error) {\n    console.error(\"[ZIRAKO DB] Error ejecutando query:\", error)\n    throw error\n  }\n}\n\n// 5. Verificar conexión (Opcional, para debugging)\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const connection = await pool.getConnection()\n    await connection.ping()\n    connection.release()\n    console.log(\"[ZIRAKO DB] Conexión a MySQL Railway exitosa\")\n    return true\n  } catch (error) {\n    console.error(\"[ZIRAKO DB] Error conectando a MySQL Railway:\", error)\n    return false\n  }\n}\n\nexport default pool"],"names":[],"mappings":";;;;;;;;AAAA;;AAOA,IAAI;AAEJ,kCAAkC;AAClC,iEAAiE;AACjE,MAAM,WAAW;IACf,KAAK,QAAQ,GAAG,CAAC,YAAY;IAC7B,MAAM,QAAQ,GAAG,CAAC,UAAU;IAC5B,MAAM,QAAQ,GAAG,CAAC,UAAU;IAC5B,UAAU,QAAQ,GAAG,CAAC,cAAc;IACpC,UAAU,QAAQ,GAAG,CAAC,cAAc;IACpC,MAAM,OAAO,QAAQ,GAAG,CAAC,UAAU,KAAK;IACxC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AACzB;AAEA,mEAAmE;AACnE,IAAI,CAAC,OAAO,SAAS,EAAE;IACrB,gDAAgD;IAChD,IAAI,QAAQ,GAAG,CAAC,YAAY,EAAE;QAC1B,OAAO,SAAS,GAAG,2NAAK,CAAC,UAAU,CAAC;YAChC,KAAK,QAAQ,GAAG,CAAC,YAAY;YAC7B,oBAAoB;YACpB,iBAAiB;YACjB,iBAAiB;QACrB;IACJ,OAAO;QACH,yCAAyC;QACzC,OAAO,SAAS,GAAG,2NAAK,CAAC,UAAU,CAAC;IACxC;AACF;AAEA,OAAO,OAAO,SAAS;AAGhB,eAAe,MAAe,GAAW,EAAE,MAAc;IAC9D,IAAI;QACF,MAAM,CAAC,MAAM,OAAO,GAAG,MAAM,KAAK,OAAO,CAAC,KAAK,UAAU,EAAE;QAC3D,OAAO;YAAE,MAAM;YAAa;QAAO;IACrC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,MAAM;IACR;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,aAAa,MAAM,KAAK,aAAa;QAC3C,MAAM,WAAW,IAAI;QACrB,WAAW,OAAO;QAClB,QAAQ,GAAG,CAAC;QACZ,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iDAAiD;QAC/D,OAAO;IACT;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 189, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yeral/Downloads/PRUEBAIA/lib/auth.ts"],"sourcesContent":["import bcrypt from \"bcryptjs\"\nimport jwt from \"jsonwebtoken\"\nimport { query } from \"./db\"\n\nconst JWT_SECRET = process.env.JWT_SECRET || \"zirako-secret-key-2024-change-in-production\"\nconst JWT_EXPIRES_IN = \"7d\"\n\n// Interfaz para el payload del JWT\nexport interface JWTPayload {\n  userId: number\n  email: string\n  name: string\n}\n\n// Interfaz para los datos de registro\ninterface RegisterProps {\n  email: string\n  password: string\n  name: string\n  rol_id: number // Ahora es el ID de la tabla roles\n  tipo_documento: string\n  numero_documento: string\n  phone?: string\n  ciudad?: string\n  direccion?: string\n}\n\n// Hash de contraseña\nexport async function hashPassword(password: string): Promise<string> {\n  const salt = await bcrypt.genSalt(12)\n  return bcrypt.hash(password, salt)\n}\n\n// Verificar contraseña\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\n  return bcrypt.compare(password, hash)\n}\n\n// Generar token JWT\nexport function generateToken(payload: JWTPayload): string {\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN })\n}\n\n// Verificar token JWT\nexport function verifyToken(token: string): JWTPayload | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as JWTPayload\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error al verificar token:\", error)\n    return null\n  }\n}\n\n// Generar token de verificación de email\nexport function generateVerificationToken(): string {\n  return jwt.sign({ purpose: \"email-verification\" }, JWT_SECRET, { expiresIn: \"24h\" })\n}\n\n// Generar token de recuperación de contraseña\nexport function generatePasswordResetToken(): string {\n  return jwt.sign({ purpose: \"password-reset\" }, JWT_SECRET, { expiresIn: \"1h\" })\n}\n\n// Registrar nuevo usuario\nexport async function registerUser({\n  email,\n  password,\n  name,\n  rol_id,\n  tipo_documento,\n  numero_documento,\n  phone,\n  ciudad,\n  direccion\n}: RegisterProps) {\n  try {\n    // Verificar si el usuario ya existe\n    const existingUser = await query<any>(\"SELECT id FROM usuarios WHERE email = ?\", [email])\n    if (existingUser.rows.length > 0) {\n      return { success: false, error: \"El correo electrónico ya está registrado\" }\n    }\n\n    // Verificar si el documento ya existe\n    const existingDoc = await query<any>(\"SELECT id FROM usuarios WHERE numero_documento = ?\", [numero_documento])\n    if (existingDoc.rows.length > 0) {\n      return { success: false, error: \"El número de documento ya está registrado\" }\n    }\n\n    // Hash de la contraseña\n    const passwordHash = await hashPassword(password)\n    const verificationToken = generateVerificationToken()\n\n    // Insertar usuario (usando rol_id)\n    await query<any>(\n      `INSERT INTO usuarios (\n          email, password_hash, nombre, rol_id, tipo_documento, numero_documento, \n          telefono, ciudad, direccion, token_verificacion, puntos, nivel\n       ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, 1)`,\n      [\n        email, \n        passwordHash, \n        name, \n        rol_id || 1, // Por defecto rol 1 (Persona) si no viene\n        tipo_documento || 'CC', \n        numero_documento, \n        phone || null, \n        ciudad || \"Cali\", \n        direccion || null, \n        verificationToken\n      ],\n    )\n\n    // Obtener el usuario insertado con el nombre de su rol\n    const newUser = await query<any>(\n      `SELECT u.id, u.email, u.nombre, r.nombre as rol, u.created_at \n       FROM usuarios u \n       JOIN roles r ON u.rol_id = r.id \n       WHERE u.email = ?`,\n      [email],\n    )\n\n    const user = newUser.rows[0]\n\n    return {\n      success: true,\n      user: {\n        id: user.id,\n        email: user.email,\n        name: user.nombre,\n        rol: user.rol, // Devolvemos el nombre del rol (ej: 'empresa')\n        createdAt: user.created_at,\n      },\n      verificationToken,\n    }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error registro:\", error)\n    return { success: false, error: \"Error interno al registrar\" }\n  }\n}\n\n// Iniciar sesión\nexport async function loginUser(email: string, password: string) {\n  try {\n    // Buscar usuario por email y obtener el nombre de su rol\n    const result = await query<any>(\n      `SELECT u.id, u.email, u.password_hash, u.nombre, r.nombre as rol, \n              u.telefono, u.ciudad, u.puntos, u.nivel, u.email_verificado \n       FROM usuarios u\n       JOIN roles r ON u.rol_id = r.id\n       WHERE u.email = ?`,\n      [email],\n    )\n\n    if (result.rows.length === 0) {\n      return { success: false, error: \"Credenciales inválidas\" }\n    }\n\n    const user = result.rows[0]\n\n    // Verificar contraseña\n    const isValidPassword = await verifyPassword(password, user.password_hash)\n\n    if (!isValidPassword) {\n      return { success: false, error: \"Credenciales inválidas\" }\n    }\n\n    await query(\"UPDATE usuarios SET ultimo_login = NOW() WHERE id = ?\", [user.id])\n\n    // Generar token JWT\n    const token = generateToken({\n      userId: user.id,\n      email: user.email,\n      name: user.nombre,\n    })\n\n    return {\n      success: true,\n      token,\n      user: {\n        id: user.id,\n        email: user.email,\n        name: user.nombre,\n        rol: user.rol,\n        phone: user.telefono,\n        city: user.ciudad,\n        points: user.puntos,\n        level: user.nivel || 1,\n        emailVerified: user.email_verificado,\n      },\n    }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error al iniciar sesión:\", error)\n    return { success: false, error: \"Error al iniciar sesión\" }\n  }\n}\n\n// Verificar email\nexport async function verifyEmail(token: string) {\n  try {\n    const result = await query<any>(\"SELECT id, email, nombre FROM usuarios WHERE token_verificacion = ?\", [token])\n\n    if (result.rows.length === 0) {\n      return { success: false, error: \"Token de verificación inválido\" }\n    }\n\n    const user = result.rows[0]\n\n    await query(\"UPDATE usuarios SET email_verificado = TRUE, token_verificacion = NULL WHERE id = ?\", [user.id])\n\n    return { success: true, message: \"Email verificado exitosamente\", user }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error al verificar email:\", error)\n    return { success: false, error: \"Error al verificar email\" }\n  }\n}\n\n// Solicitar recuperación de contraseña\nexport async function requestPasswordReset(email: string) {\n  try {\n    const result = await query<any>(\"SELECT id, nombre FROM usuarios WHERE email = ?\", [email])\n\n    if (result.rows.length === 0) {\n      return { success: true, message: \"Si el correo existe, recibirás un enlace de recuperación\" }\n    }\n\n    const user = result.rows[0]\n    const resetToken = generatePasswordResetToken()\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000) // 1 hora\n\n    await query(\"UPDATE usuarios SET token_reset_password = ?, reset_password_expira = ? WHERE id = ?\", [\n      resetToken,\n      expiresAt,\n      user.id,\n    ])\n\n    return { success: true, resetToken, user }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error recuperación contraseña:\", error)\n    return { success: false, error: \"Error al procesar la solicitud\" }\n  }\n}\n\n// Restablecer contraseña\nexport async function resetPassword(token: string, newPassword: string) {\n  try {\n    const result = await query<any>(\n      \"SELECT id FROM usuarios WHERE token_reset_password = ? AND reset_password_expira > NOW()\",\n      [token],\n    )\n\n    if (result.rows.length === 0) {\n      return { success: false, error: \"Token inválido o expirado\" }\n    }\n\n    const user = result.rows[0]\n    const passwordHash = await hashPassword(newPassword)\n\n    await query(\n      \"UPDATE usuarios SET password_hash = ?, token_reset_password = NULL, reset_password_expira = NULL WHERE id = ?\",\n      [passwordHash, user.id],\n    )\n\n    return { success: true, message: \"Contraseña actualizada exitosamente\" }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error restablecer contraseña:\", error)\n    return { success: false, error: \"Error al restablecer contraseña\" }\n  }\n}\n\n// Obtener usuario por ID (con rol desde la tabla roles)\nexport async function getUserById(id: number) {\n  try {\n    const result = await query<any>(\n      `SELECT u.id, u.email, u.nombre, r.nombre as rol, u.telefono, u.ciudad, u.direccion, \n              u.puntos, u.nivel, u.email_verificado, u.created_at \n       FROM usuarios u\n       JOIN roles r ON u.rol_id = r.id\n       WHERE u.id = ?`,\n      [id],\n    )\n\n    if (result.rows.length === 0) return null\n\n    const user = result.rows[0]\n    return {\n      id: user.id,\n      email: user.email,\n      name: user.nombre,\n      rol: user.rol,\n      phone: user.telefono,\n      city: user.ciudad,\n      address: user.direccion,\n      points: user.puntos,\n      level: user.nivel || 1,\n      emailVerified: user.email_verificado,\n      createdAt: user.created_at,\n    }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error obtener usuario:\", error)\n    return null\n  }\n}\n\nexport async function addPointsToUser(userId: number, points: number, reason: string) {\n  try {\n    await query(\"UPDATE usuarios SET puntos = puntos + ? WHERE id = ?\", [points, userId])\n\n    // Recalcular nivel\n    const result = await query<any>(\"SELECT puntos FROM usuarios WHERE id = ?\", [userId])\n    if (result.rows.length > 0) {\n      const totalPoints = result.rows[0].puntos\n      let newLevel = 1\n      if (totalPoints >= 1000) newLevel = 5 \n      else if (totalPoints >= 500) newLevel = 4 \n      else if (totalPoints >= 200) newLevel = 3 \n      else if (totalPoints >= 50) newLevel = 2 \n\n      await query(\"UPDATE usuarios SET nivel = ? WHERE id = ?\", [newLevel, userId])\n    }\n    return { success: true }\n  } catch (error) {\n    console.error(\"[ZIRAKO AUTH] Error agregar puntos:\", error)\n    return { success: false }\n  }\n}"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAC7C,MAAM,iBAAiB;AAuBhB,eAAe,aAAa,QAAgB;IACjD,MAAM,OAAO,MAAM,4NAAM,CAAC,OAAO,CAAC;IAClC,OAAO,4NAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAGO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,4NAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAGO,SAAS,cAAc,OAAmB;IAC/C,OAAO,oOAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAe;AACnE;AAGO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,oOAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;IACT;AACF;AAGO,SAAS;IACd,OAAO,oOAAG,CAAC,IAAI,CAAC;QAAE,SAAS;IAAqB,GAAG,YAAY;QAAE,WAAW;IAAM;AACpF;AAGO,SAAS;IACd,OAAO,oOAAG,CAAC,IAAI,CAAC;QAAE,SAAS;IAAiB,GAAG,YAAY;QAAE,WAAW;IAAK;AAC/E;AAGO,eAAe,aAAa,EACjC,KAAK,EACL,QAAQ,EACR,IAAI,EACJ,MAAM,EACN,cAAc,EACd,gBAAgB,EAChB,KAAK,EACL,MAAM,EACN,SAAS,EACK;IACd,IAAI;QACF,oCAAoC;QACpC,MAAM,eAAe,MAAM,IAAA,6IAAK,EAAM,2CAA2C;YAAC;SAAM;QACxF,IAAI,aAAa,IAAI,CAAC,MAAM,GAAG,GAAG;YAChC,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA2C;QAC7E;QAEA,sCAAsC;QACtC,MAAM,cAAc,MAAM,IAAA,6IAAK,EAAM,sDAAsD;YAAC;SAAiB;QAC7G,IAAI,YAAY,IAAI,CAAC,MAAM,GAAG,GAAG;YAC/B,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA4C;QAC9E;QAEA,wBAAwB;QACxB,MAAM,eAAe,MAAM,aAAa;QACxC,MAAM,oBAAoB;QAE1B,mCAAmC;QACnC,MAAM,IAAA,6IAAK,EACT,CAAC;;;oDAG6C,CAAC,EAC/C;YACE;YACA;YACA;YACA,UAAU;YACV,kBAAkB;YAClB;YACA,SAAS;YACT,UAAU;YACV,aAAa;YACb;SACD;QAGH,uDAAuD;QACvD,MAAM,UAAU,MAAM,IAAA,6IAAK,EACzB,CAAC;;;wBAGiB,CAAC,EACnB;YAAC;SAAM;QAGT,MAAM,OAAO,QAAQ,IAAI,CAAC,EAAE;QAE5B,OAAO;YACL,SAAS;YACT,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,MAAM,KAAK,MAAM;gBACjB,KAAK,KAAK,GAAG;gBACb,WAAW,KAAK,UAAU;YAC5B;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;AACF;AAGO,eAAe,UAAU,KAAa,EAAE,QAAgB;IAC7D,IAAI;QACF,yDAAyD;QACzD,MAAM,SAAS,MAAM,IAAA,6IAAK,EACxB,CAAC;;;;wBAIiB,CAAC,EACnB;YAAC;SAAM;QAGT,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAyB;QAC3D;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAE3B,uBAAuB;QACvB,MAAM,kBAAkB,MAAM,eAAe,UAAU,KAAK,aAAa;QAEzE,IAAI,CAAC,iBAAiB;YACpB,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAyB;QAC3D;QAEA,MAAM,IAAA,6IAAK,EAAC,yDAAyD;YAAC,KAAK,EAAE;SAAC;QAE9E,oBAAoB;QACpB,MAAM,QAAQ,cAAc;YAC1B,QAAQ,KAAK,EAAE;YACf,OAAO,KAAK,KAAK;YACjB,MAAM,KAAK,MAAM;QACnB;QAEA,OAAO;YACL,SAAS;YACT;YACA,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,MAAM,KAAK,MAAM;gBACjB,KAAK,KAAK,GAAG;gBACb,OAAO,KAAK,QAAQ;gBACpB,MAAM,KAAK,MAAM;gBACjB,QAAQ,KAAK,MAAM;gBACnB,OAAO,KAAK,KAAK,IAAI;gBACrB,eAAe,KAAK,gBAAgB;YACtC;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0CAA0C;QACxD,OAAO;YAAE,SAAS;YAAO,OAAO;QAA0B;IAC5D;AACF;AAGO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,6IAAK,EAAM,uEAAuE;YAAC;SAAM;QAE9G,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAiC;QACnE;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAE3B,MAAM,IAAA,6IAAK,EAAC,uFAAuF;YAAC,KAAK,EAAE;SAAC;QAE5G,OAAO;YAAE,SAAS;YAAM,SAAS;YAAiC;QAAK;IACzE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2CAA2C;QACzD,OAAO;YAAE,SAAS;YAAO,OAAO;QAA2B;IAC7D;AACF;AAGO,eAAe,qBAAqB,KAAa;IACtD,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,6IAAK,EAAM,mDAAmD;YAAC;SAAM;QAE1F,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO;gBAAE,SAAS;gBAAM,SAAS;YAA2D;QAC9F;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAC3B,MAAM,aAAa;QACnB,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,MAAM,SAAS;;QAEjE,MAAM,IAAA,6IAAK,EAAC,wFAAwF;YAClG;YACA;YACA,KAAK,EAAE;SACR;QAED,OAAO;YAAE,SAAS;YAAM;YAAY;QAAK;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gDAAgD;QAC9D,OAAO;YAAE,SAAS;YAAO,OAAO;QAAiC;IACnE;AACF;AAGO,eAAe,cAAc,KAAa,EAAE,WAAmB;IACpE,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,6IAAK,EACxB,4FACA;YAAC;SAAM;QAGT,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAA4B;QAC9D;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAC3B,MAAM,eAAe,MAAM,aAAa;QAExC,MAAM,IAAA,6IAAK,EACT,iHACA;YAAC;YAAc,KAAK,EAAE;SAAC;QAGzB,OAAO;YAAE,SAAS;YAAM,SAAS;QAAsC;IACzE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+CAA+C;QAC7D,OAAO;YAAE,SAAS;YAAO,OAAO;QAAkC;IACpE;AACF;AAGO,eAAe,YAAY,EAAU;IAC1C,IAAI;QACF,MAAM,SAAS,MAAM,IAAA,6IAAK,EACxB,CAAC;;;;qBAIc,CAAC,EAChB;YAAC;SAAG;QAGN,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG,OAAO;QAErC,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAC3B,OAAO;YACL,IAAI,KAAK,EAAE;YACX,OAAO,KAAK,KAAK;YACjB,MAAM,KAAK,MAAM;YACjB,KAAK,KAAK,GAAG;YACb,OAAO,KAAK,QAAQ;YACpB,MAAM,KAAK,MAAM;YACjB,SAAS,KAAK,SAAS;YACvB,QAAQ,KAAK,MAAM;YACnB,OAAO,KAAK,KAAK,IAAI;YACrB,eAAe,KAAK,gBAAgB;YACpC,WAAW,KAAK,UAAU;QAC5B;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO;IACT;AACF;AAEO,eAAe,gBAAgB,MAAc,EAAE,MAAc,EAAE,MAAc;IAClF,IAAI;QACF,MAAM,IAAA,6IAAK,EAAC,wDAAwD;YAAC;YAAQ;SAAO;QAEpF,mBAAmB;QACnB,MAAM,SAAS,MAAM,IAAA,6IAAK,EAAM,4CAA4C;YAAC;SAAO;QACpF,IAAI,OAAO,IAAI,CAAC,MAAM,GAAG,GAAG;YAC1B,MAAM,cAAc,OAAO,IAAI,CAAC,EAAE,CAAC,MAAM;YACzC,IAAI,WAAW;YACf,IAAI,eAAe,MAAM,WAAW;iBAC/B,IAAI,eAAe,KAAK,WAAW;iBACnC,IAAI,eAAe,KAAK,WAAW;iBACnC,IAAI,eAAe,IAAI,WAAW;YAEvC,MAAM,IAAA,6IAAK,EAAC,8CAA8C;gBAAC;gBAAU;aAAO;QAC9E;QACA,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,OAAO;YAAE,SAAS;QAAM;IAC1B;AACF","debugId":null}},
    {"offset": {"line": 539, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/yeral/Downloads/PRUEBAIA/app/api/impacto/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { verifyToken } from \"@/lib/auth\"\nimport { cookies } from \"next/headers\"\n\n// GET /api/impacto - Obtener impacto ambiental del usuario\nexport async function GET(request: NextRequest) {\n  try {\n    const cookieStore = await cookies()\n    const token = cookieStore.get(\"auth-token\")?.value\n\n    if (!token) {\n      return NextResponse.json({ success: false, error: \"No autorizado\" }, { status: 401 })\n    }\n\n    const payload = verifyToken(token)\n    if (!payload) {\n      return NextResponse.json({ success: false, error: \"Sesión expirada\" }, { status: 401 })\n    }\n\n    // 1. Total de CO2 ahorrado\n    const totalResult = await query<any>(\n      `SELECT \n        COALESCE(SUM(co2_ahorrado), 0) AS total_co2,\n        COUNT(*) AS total_acciones\n       FROM impacto_ambiental WHERE usuario_id = ?`,\n      [payload.userId],\n    )\n\n    // 2. Desglose por tipo de acción\n    const desgloseResult = await query<any>(\n      `SELECT \n        tipo_accion,\n        COUNT(*) AS cantidad,\n        SUM(co2_ahorrado) AS co2_total\n       FROM impacto_ambiental \n       WHERE usuario_id = ?\n       GROUP BY tipo_accion`,\n      [payload.userId],\n    )\n\n    // 3. Impacto por mes (últimos 6 meses)\n    const mensualResult = await query<any>(\n      `SELECT \n        DATE_FORMAT(created_at, '%Y-%m') AS mes,\n        SUM(co2_ahorrado) AS co2_mes,\n        COUNT(*) AS acciones_mes\n       FROM impacto_ambiental \n       WHERE usuario_id = ? \n         AND created_at >= DATE_SUB(NOW(), INTERVAL 6 MONTH)\n       GROUP BY DATE_FORMAT(created_at, '%Y-%m')\n       ORDER BY mes DESC`,\n      [payload.userId],\n    )\n\n    // 4. Últimas acciones\n    const ultimasResult = await query<any>(\n      `SELECT ia.*, i.titulo AS nombre_item\n       FROM impacto_ambiental ia\n       LEFT JOIN items i ON ia.item_id = i.id\n       WHERE ia.usuario_id = ?\n       ORDER BY ia.created_at DESC\n       LIMIT 10`,\n      [payload.userId],\n    )\n\n    const total = totalResult.rows[0] || { total_co2: 0, total_acciones: 0 }\n\n    // --- TRANSFORMACIÓN DE DATOS (ESTA ES LA CLAVE) ---\n    // Convertimos la lista de la BD en un objeto fácil de leer\n    const por_tipo: Record<string, number> = {\n      donacion: 0,\n      intercambio: 0,\n      venta: 0,\n      recoleccion: 0\n    }\n\n    // Llenamos el objeto con los datos reales\n    desgloseResult.rows.forEach((row: any) => {\n      const tipo = row.tipo_accion; \n      if (tipo && por_tipo.hasOwnProperty(tipo)) {\n        por_tipo[tipo] = Number(row.cantidad);\n      }\n    });\n\n    // Calcular equivalencias ambientales\n    const co2Total = Number(total.total_co2) || 0\n    const equivalencias = {\n      arboles_equivalentes: Math.round(co2Total / 21),\n      km_auto_evitados: Math.round(co2Total / 0.12),\n      litros_agua_ahorrados: Math.round(co2Total * 100),\n      bolsas_plastico_evitadas: Math.round(co2Total * 10),\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        total_co2_ahorrado: co2Total,\n        total_acciones: Number(total.total_acciones) || 0,\n        por_tipo: por_tipo, // <--- Aquí enviamos el desglose corregido\n        desglose: desgloseResult.rows,\n        mensual: mensualResult.rows,\n        ultimas_acciones: ultimasResult.rows,\n        equivalencias,\n      },\n    })\n  } catch (error) {\n    console.error(\"[API IMPACTO] Error:\", error)\n    return NextResponse.json({ success: false, error: \"Error al obtener impacto\" }, { status: 500 })\n  }\n}\n\n// POST /api/impacto - Registrar nueva acción de impacto\nexport async function POST(request: NextRequest) {\n  try {\n    const cookieStore = await cookies()\n    const token = cookieStore.get(\"auth-token\")?.value\n\n    if (!token) {\n      return NextResponse.json({ success: false, error: \"No autorizado\" }, { status: 401 })\n    }\n\n    const payload = verifyToken(token)\n    if (!payload) {\n      return NextResponse.json({ success: false, error: \"Sesión expirada\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { tipo_accion, item_id, descripcion } = body\n\n    if (!tipo_accion || ![\"donacion\", \"venta\", \"intercambio\", \"recoleccion\"].includes(tipo_accion)) {\n      return NextResponse.json({ success: false, error: \"Tipo de acción inválido\" }, { status: 400 })\n    }\n\n    const co2_ahorrado = CO2_POR_ACCION[tipo_accion as keyof typeof CO2_POR_ACCION]\n    const puntos = PUNTOS_POR_ACCION[tipo_accion as keyof typeof PUNTOS_POR_ACCION]\n\n    // Registrar impacto ambiental\n    await query(\n      `INSERT INTO impacto_ambiental (usuario_id, item_id, tipo_accion, co2_ahorrado, descripcion)\n       VALUES (?, ?, ?, ?, ?)`,\n      [payload.userId, item_id || null, tipo_accion, co2_ahorrado, descripcion || `Acción de ${tipo_accion}`],\n    )\n\n    // Actualizar puntos del usuario\n    await query(`UPDATE usuarios SET puntos = puntos + ? WHERE id = ?`, [puntos, payload.userId])\n\n    // Actualizar nivel si corresponde\n    const userResult = await query<any>(`SELECT puntos FROM usuarios WHERE id = ?`, [payload.userId])\n    const nuevosPuntos = userResult.rows[0]?.puntos || 0\n    const nuevoNivel = calcularNivel(nuevosPuntos)\n\n    await query(`UPDATE usuarios SET nivel = ? WHERE id = ?`, [nuevoNivel, payload.userId])\n\n    return NextResponse.json({\n      success: true,\n      message: \"Impacto registrado\",\n      data: {\n        co2_ahorrado,\n        puntos_ganados: puntos,\n        puntos_totales: nuevosPuntos,\n        nivel: nuevoNivel,\n      },\n    })\n  } catch (error) {\n    console.error(\"[API IMPACTO] Error:\", error)\n    return NextResponse.json({ success: false, error: \"Error al registrar impacto\" }, { status: 500 })\n  }\n}\n\nfunction calcularNivel(puntos: number): number {\n  if (puntos >= 5000) return 5\n  if (puntos >= 2000) return 4\n  if (puntos >= 1000) return 3\n  if (puntos >= 500) return 2\n  return 1\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}